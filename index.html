<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Groq Glass Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ===== MARKDOWN ===== -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* =======================
       GLOBAL STYLES
    ======================= */
    * {
      box-sizing: border-box;
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      margin: 0;
      height: 100vh;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color: #e5e7eb;
      overflow: hidden;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      background: linear-gradient(135deg, #7c3aed, #a78bfa);
      color: #fff;
      font-weight: 500;
      transition: transform .15s ease, box-shadow .15s ease, opacity .15s ease;
      box-shadow: 0 0 15px rgba(124,58,237,.4);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 22px rgba(167,139,250,.6);
    }

    button.secondary {
      background: rgba(255,255,255,.08);
      box-shadow: none;
    }

    button.danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    input, select, textarea {
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 10px 12px;
      color: #fff;
      outline: none;
    }

    textarea {
      resize: none;
    }

    /* =======================
       LAYOUT
    ======================= */
    .app {
      display: grid;
      grid-template-columns: 280px 1fr;
      height: 100%;
    }

    /* =======================
       SIDEBAR (CHATS)
    ======================= */
    .sidebar {
      backdrop-filter: blur(16px);
      background: rgba(255,255,255,.06);
      border-right: 1px solid rgba(255,255,255,.12);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .sidebar h2 {
      margin: 0;
      font-size: 18px;
      color: #a78bfa;
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chat-item {
      padding: 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.05);
      cursor: pointer;
      transition: background .15s ease;
    }

    .chat-item:hover {
      background: rgba(255,255,255,.12);
    }

    .chat-item.active {
      background: rgba(167,139,250,.25);
    }

    /* =======================
       MAIN CHAT AREA
    ======================= */
    .main {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .top-bar {
      padding: 14px;
      backdrop-filter: blur(16px);
      background: rgba(255,255,255,.06);
      border-bottom: 1px solid rgba(255,255,255,.12);
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .message {
      max-width: 75%;
      padding: 14px 16px;
      border-radius: 16px;
      animation: fadeIn .25s ease;
      line-height: 1.45;
    }

    .user {
      align-self: flex-end;
      background: linear-gradient(135deg, #7c3aed, #a78bfa);
      color: #fff;
    }

    .assistant {
      align-self: flex-start;
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
    }

    .typing {
      opacity: .6;
      font-style: italic;
    }

    .input-bar {
      padding: 16px;
      display: flex;
      gap: 10px;
      backdrop-filter: blur(16px);
      background: rgba(255,255,255,.06);
      border-top: 1px solid rgba(255,255,255,.12);
    }

    .input-bar textarea {
      flex: 1;
      height: 52px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .cooldown {
      color: #fbbf24;
      font-size: 13px;
    }
  </style>
</head>
<body>

<div class="app">
  <!-- =======================
       SIDEBAR
  ======================= -->
  <aside class="sidebar">
    <h2>üí¨ –ß–∞—Ç—ã</h2>
    <button id="newChatBtn">‚ûï –ù–æ–≤—ã–π —á–∞—Ç</button>
    <div class="chat-list" id="chatList"></div>
  </aside>

  <!-- =======================
       MAIN
  ======================= -->
  <main class="main">
    <div class="top-bar">
      <input id="apiKeyInput" type="password" placeholder="Groq API Key" />
      <select id="modelSelect"></select>
      <span class="cooldown" id="cooldownText"></span>
      <button id="stopBtn" class="danger" style="display:none;">‚õî –°—Ç–æ–ø</button>
      <button id="speakBtn" class="secondary">üîä –û–∑–≤—É—á–∏—Ç—å</button>
      <button id="clearBtn" class="secondary">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

    <div class="messages" id="messages"></div>

    <div class="input-bar">
      <textarea id="userInput" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
      <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </main>
</div>

<script>
/* ======================================================
   CONFIG
====================================================== */
const GROQ_ENDPOINT = "https://api.groq.com/openai/v1/chat/completions";
const COOLDOWN_MS = 3000;

const MODELS = [
  "llama-3.3-70b-versatile",
  "llama-3.1-70b",
  "llama-3.1-8b",
  "mixtral-8x7b-32768",
  "gemma2-9b-it",
  "deepseek-r1-distill-llama-70b",
  "deepseek-r1-distill-qwen-32b",
  "qwen-qwq-32b",
  "qwen2.5-32b-instruct",
  "llama-3.2-11b-vision-preview",
  "llama-3.2-90b-vision-preview"
];

/* ======================================================
   STATE
====================================================== */
let chats = JSON.parse(localStorage.getItem("groq_chats") || "[]");
let currentChatId = null;
let abortController = null;
let lastSendTime = 0;

/* ======================================================
   INIT
====================================================== */
const modelSelect = document.getElementById("modelSelect");
MODELS.forEach(m => {
  const o = document.createElement("option");
  o.value = m;
  o.textContent = m;
  modelSelect.appendChild(o);
});

document.getElementById("apiKeyInput").value =
  localStorage.getItem("groq_api_key") || "";

renderChatList();
if (!chats.length) newChat();

/* ======================================================
   CHAT MANAGEMENT
====================================================== */
function newChat() {
  const chat = {
    id: Date.now(),
    title: "–ù–æ–≤—ã–π —á–∞—Ç",
    messages: []
  };
  chats.unshift(chat);
  currentChatId = chat.id;
  saveChats();
  renderChatList();
  renderMessages();
}

function saveChats() {
  localStorage.setItem("groq_chats", JSON.stringify(chats));
}

function renderChatList() {
  const list = document.getElementById("chatList");
  list.innerHTML = "";
  chats.forEach(chat => {
    const div = document.createElement("div");
    div.className = "chat-item" + (chat.id === currentChatId ? " active" : "");
    div.textContent = chat.title;
    div.onclick = () => {
      currentChatId = chat.id;
      renderChatList();
      renderMessages();
    };
    list.appendChild(div);
  });
}

function getCurrentChat() {
  return chats.find(c => c.id === currentChatId);
}

/* ======================================================
   RENDER MESSAGES
====================================================== */
function renderMessages() {
  const container = document.getElementById("messages");
  container.innerHTML = "";
  const chat = getCurrentChat();
  chat.messages.forEach(m => {
    const div = document.createElement("div");
    div.className = "message " + m.role;
    div.innerHTML = marked.parse(m.content);
    container.appendChild(div);
  });
  container.scrollTop = container.scrollHeight;
}

/* ======================================================
   SEND MESSAGE
====================================================== */
async function sendMessage() {
  const now = Date.now();
  if (now - lastSendTime < COOLDOWN_MS) {
    document.getElementById("cooldownText").textContent =
      `–ü–æ–¥–æ–∂–¥–∏ ${Math.ceil((COOLDOWN_MS - (now - lastSendTime))/1000)} —Å–µ–∫`;
    return;
  }
  document.getElementById("cooldownText").textContent = "";
  lastSendTime = now;

  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;
  input.value = "";

  const chat = getCurrentChat();
  chat.messages.push({ role: "user", content: text });

  if (chat.messages.length === 1) {
    chat.title = text.slice(0, 40);
  }

  saveChats();
  renderChatList();
  renderMessages();

  await streamAssistantResponse();
}

/* ======================================================
   STREAMING
====================================================== */
async function streamAssistantResponse() {
  const chat = getCurrentChat();
  const apiKey = document.getElementById("apiKeyInput").value;
  localStorage.setItem("groq_api_key", apiKey);

  const assistantMsg = { role: "assistant", content: "" };
  chat.messages.push(assistantMsg);
  renderMessages();

  abortController = new AbortController();
  document.getElementById("stopBtn").style.display = "inline-block";

  try {
    const res = await fetch(GROQ_ENDPOINT, {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + apiKey,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: modelSelect.value,
        messages: chat.messages,
        stream: true,
        temperature: 0.7,
        max_tokens: 2048
      }),
      signal: abortController.signal
    });

    if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ API: " + res.status);

    const reader = res.body.getReader();
    const decoder = new TextDecoder();

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      chunk.split("\n").forEach(line => {
        if (!line.startsWith("data:")) return;
        const data = line.replace("data:", "").trim();
        if (data === "[DONE]") return;
        const json = JSON.parse(data);
        const token = json.choices?.[0]?.delta?.content;
        if (token) {
          assistantMsg.content += token;
          renderMessages();
        }
      });
    }
  } catch (e) {
    assistantMsg.content = "‚ùå –û—à–∏–±–∫–∞: " + e.message;
  } finally {
    document.getElementById("stopBtn").style.display = "none";
    saveChats();
  }
}

/* ======================================================
   BUTTONS
====================================================== */
document.getElementById("sendBtn").onclick = sendMessage;
document.getElementById("newChatBtn").onclick = newChat;
document.getElementById("stopBtn").onclick = () => abortController?.abort();
document.getElementById("clearBtn").onclick = () => {
  getCurrentChat().messages = [];
  saveChats();
  renderMessages();
};

document.getElementById("speakBtn").onclick = () => {
  const chat = getCurrentChat();
  const last = [...chat.messages].reverse().find(m => m.role === "assistant");
  if (!last) return;
  const u = new SpeechSynthesisUtterance(last.content);
  u.lang = "ru-RU";
  speechSynthesis.speak(u);
};
</script>

</body>
  </html>
